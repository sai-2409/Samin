<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google fonts and icons-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- Connecting the logo to the browser tab -->
    <link
    rel="shortcut icon"
    href="{{ url_for('static', filename='images/logo__walnuts-print-version.svg') }}"
    type="image/x-icon"
    />
    <title>Dashboard</title>
  </head>
  <body class="bg-gray-100 font-['Roboto'] min-h-screen">
    <div class="min-h-screen flex flex-col">
      <!-- Header -->
      <header class="bg-white shadow p-6 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <img
            src="/static/images/logoWalnuts-welcome-page.svg"
            alt="Samin Logo"
            class="h-12 w-12 rounded-full bg-gray-200"
          />
          <h1 class="text-3xl font-bold text-orange-700 tracking-wide">
            Samin Admin Dashboard
          </h1>
        </div>
        <div class="text-gray-600 font-medium">Добро пожаловать, Админ!</div>
      </header>

      <!-- Main Content -->
      <main class="flex-1 p-8 flex flex-col gap-8 max-w-7xl mx-auto w-full">
        <!-- Sales Overview -->
        <section
          class="bg-white rounded-2xl shadow p-6 flex flex-col md:flex-row items-center justify-between gap-6"
        >
          <div>
            <h2 class="text-xl font-semibold text-gray-800 mb-2">
              Продажи за сегодня
            </h2>
            <div class="text-4xl font-bold text-green-600">
              ₽ {{ orders | selectattr('order_id') | map(attribute='total') |
              map('float') | sum | default(0) | round(2) }}
            </div>
          </div>
          <div class="flex items-center gap-4">
            <span class="text-gray-500">Обновлено:</span>
            <span class="text-gray-700"
              >{{ moment().format('HH:mm') if moment else '--:--' }}</span
            >
          </div>
        </section>

        <!-- Orders Table -->
        <section class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">
            Информация о заказах
          </h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ID заказа
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Дата заказа
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Клиент
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Адрес доставки
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Дата доставки
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Примечания
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Сумма
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Статус
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% if orders %} {% for order in orders %} {% if order.order_id
                %}
                <tr class="hover:bg-gray-50">
                  <td
                    class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                  >
                    {{ order.order_id[:8] }}...
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ order.timestamp.split('T')[0] if order.timestamp else
                    'N/A' }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <div class="flex flex-col">
                      <span class="font-medium"
                        >{{ order.customer_info.name if order.customer_info else
                        'Не указано' }}</span
                      >
                      <span class="text-gray-500"
                        >{{ order.customer_info.phone if order.customer_info
                        else 'Не указано' }}</span
                      >
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-900 max-w-xs">
                    <div class="truncate">
                      {{ order.customer_info.address if order.customer_info else
                      'Не указано' }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ order.delivery_date if order.delivery_date else 'Не
                    выбрана' }}
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-900">
                    {% if order.delivery_notes %} {% for note in
                    order.delivery_notes %}
                    <span
                      class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1"
                    >
                      {{ note }}
                    </span>
                    {% endfor %} {% else %}
                    <span class="text-gray-400">Нет примечаний</span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <div class="flex flex-col">
                      <span class="font-medium">₽{{ order.total }}</span>
                      {% if order.delivery and order.delivery != '0.00' %}
                      <span class="text-xs text-gray-500"
                        >Доставка: ₽{{ order.delivery }}</span
                      >
                      {% endif %}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center space-x-2">
                      <span
                        class="inline-block px-3 py-1 rounded-full text-xs font-semibold
                        {% if order.status == 'Оформлен' %}bg-blue-100 text-blue-700
                        {% elif order.status == 'Собран' %}bg-yellow-100 text-yellow-700
                        {% elif order.status == 'Отправлен' %}bg-orange-100 text-orange-700
                        {% elif order.status == 'Доставлен' %}bg-green-100 text-green-700
                        {% else %}bg-gray-100 text-gray-700{% endif %}"
                      >
                        {{ order.status if order.status else 'Оформлен' }}
                      </span>
                      <select 
                        class="order-status-select text-xs border border-gray-300 rounded px-2 py-1 bg-white"
                        data-order-id="{{ order.order_id }}"
                        onchange="updateOrderStatus('{{ order.order_id }}', this.value)"
                      >
                        <option value="Оформлен" {% if order.status == 'Оформлен' %}selected{% endif %}>Оформлен</option>
                        <option value="Собран" {% if order.status == 'Собран' %}selected{% endif %}>Собран</option>
                        <option value="Отправлен" {% if order.status == 'Отправлен' %}selected{% endif %}>Отправлен</option>
                        <option value="Доставлен" {% if order.status == 'Доставлен' %}selected{% endif %}>Доставлен</option>
                      </select>
                    </div>
                  </td>
                </tr>
                {% endif %} {% endfor %} {% else %}
                <tr>
                  <td colspan="8" class="text-center py-6 text-gray-400">
                    Нет заказов
                  </td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </section>

        <!-- Detailed Order Information -->
        {% if orders %}
        <section class="bg-white rounded-2xl shadow p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">
            Детальная информация о заказах
          </h2>
          <div class="grid md:grid-cols-2 gap-6">
            {% for order in orders %} {% if order.order_id %}
            <div class="bg-gray-50 rounded-xl p-5 shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800">
                  Заказ #{{ order.order_id[:8] }}
                </h3>
                <span class="text-sm text-gray-500"
                  >{{ order.timestamp.split('T')[0] if order.timestamp else
                  'N/A' }}</span
                >
              </div>

              <!-- Customer Info -->
              <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2">
                  Информация о клиенте:
                </h4>
                <div class="text-sm text-gray-600 space-y-1">
                  <div>
                    <span class="font-medium">Имя:</span> {{
                    order.customer_info.name if order.customer_info else 'Не
                    указано' }}
                  </div>
                  <div>
                    <span class="font-medium">Телефон:</span> {{
                    order.customer_info.phone if order.customer_info else 'Не
                    указано' }}
                  </div>
                  <div>
                    <span class="font-medium">Адрес:</span> {{
                    order.customer_info.address if order.customer_info else 'Не
                    указано' }}
                  </div>
                  <div>
                    <span class="font-medium">Индекс:</span> {{
                    order.customer_info.zipCode if order.customer_info else 'Не
                    указано' }}
                  </div>
                </div>
              </div>

              <!-- Delivery Info -->
              <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2">
                  Информация о доставке:
                </h4>
                <div class="text-sm text-gray-600 space-y-1">
                  <div>
                    <span class="font-medium">Дата доставки:</span> {{
                    order.delivery_date if order.delivery_date else 'Не выбрана'
                    }}
                  </div>
                  <div>
                    <span class="font-medium">Примечания:</span>
                    {% if order.delivery_notes %} {% for note in
                    order.delivery_notes %}
                    <span
                      class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1"
                      >{{ note }}</span
                    >
                    {% endfor %} {% else %}
                    <span class="text-gray-400">Нет примечаний</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Order Items -->
              <div class="mb-4">
                <h4 class="font-medium text-gray-700 mb-2">Товары:</h4>
                <div
                  class="text-sm text-gray-600 space-y-1 max-h-32 overflow-y-auto"
                >
                  {% if order.cart_items %} {% for item in order.cart_items %}
                  <div class="flex justify-between">
                    <span
                      >{{ item.productName if item.productName else item.name }}
                      x{{ item.quantity }}</span
                    >
                    <span>₽{{ item.price * item.quantity }}</span>
                  </div>
                  {% endfor %} {% else %}
                  <span class="text-gray-400">Нет товаров</span>
                  {% endif %}
                </div>
              </div>

              <!-- Payment Info -->
              <div class="border-t pt-4">
                <div class="flex justify-between items-center">
                  <div class="text-sm text-gray-600">
                    <div>
                      <span class="font-medium">Подытог:</span> ₽{{
                      order.subtotal if order.subtotal else '0' }}
                    </div>
                    {% if order.delivery and order.delivery != '0.00' %}
                    <div>
                      <span class="font-medium">Доставка:</span> ₽{{
                      order.delivery }}
                    </div>
                    {% endif %}
                    <div class="font-semibold text-lg">
                      <span class="font-medium">Итого:</span> ₽{{ order.total }}
                    </div>
                  </div>
                  <span
                    class="inline-block px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold"
                  >
                    {{ order.status if order.status else 'Оформлен' }}
                  </span>
                </div>
              </div>
            </div>
            {% endif %} {% endfor %}
          </div>
        </section>
        {% endif %}
      </main>
    </div>

    <script>
      // Function to update order status
      function updateOrderStatus(orderId, newStatus) {
        // Show loading state
        const selectElement = document.querySelector(`[data-order-id="${orderId}"]`);
        const originalValue = selectElement.value;
        
        // Send update request
        fetch('/api/update-order-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            order_id: orderId,
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update the status badge
            const statusBadge = selectElement.parentElement.querySelector('span');
            statusBadge.textContent = newStatus;
            
            // Update badge colors based on status
            statusBadge.className = `inline-block px-3 py-1 rounded-full text-xs font-semibold ${
              newStatus === 'Оформлен' ? 'bg-blue-100 text-blue-700' :
              newStatus === 'Собран' ? 'bg-yellow-100 text-yellow-700' :
              newStatus === 'Отправлен' ? 'bg-orange-100 text-orange-700' :
              newStatus === 'Доставлен' ? 'bg-green-100 text-green-700' :
              'bg-gray-100 text-gray-700'
            }`;
            
            // Show success message
            showNotification('Статус заказа обновлен успешно!', 'success');
          } else {
            // Revert select to original value
            selectElement.value = originalValue;
            showNotification('Ошибка при обновлении статуса', 'error');
          }
        })
        .catch(error => {
          console.error('Error updating order status:', error);
          // Revert select to original value
          selectElement.value = originalValue;
          showNotification('Ошибка при обновлении статуса', 'error');
        });
      }

      // Function to show notifications
      function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        notification.textContent = message;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
